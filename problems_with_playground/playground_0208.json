{
  "problem_id": 208,
  "title": "Flash Attention v1 - Forward Pass",
  "category": "Deep Learning",
  "enabled": true,
  "type": "react",
  "code": "\nimport React, { useState, useMemo, useRef, useEffect, useCallback } from 'react';\n\nconst theme = {\n  colors: {\n    primary: '#8b5cf6',\n    background: '#0a0a0a',\n    surface: '#111111',\n    surfaceAlt: '#1a1a1a',\n    border: '#2a2a2a',\n    text: '#fafafa',\n    textSecondary: '#a1a1aa',\n    textMuted: '#52525b',\n    positive: '#10b981',\n    negative: '#f43f5e',\n    blue: '#38bdf8',\n    yellow: '#fbbf24',\n    pink: '#f472b6',\n    orange: '#fb923c',\n    cyan: '#22d3ee',\n    green: '#4ade80',\n  },\n  font: \"'JetBrains Mono', monospace\",\n};\n\nconst words = [\"The\", \"cat\", \"sat\", \"on\"];\nconst N = words.length;\nconst BLOCK_SIZE = 2;\nconst NUM_BLOCKS = Math.ceil(N / BLOCK_SIZE);\n\n// Embeddings (simplified 1D for visualization)\nconst embeddings = [0.9, 1.1, 0.8, 0.7];\n\n// Weight matrices (simplified scalars)\nconst Wq = 0.9, Wk = 0.7, Wv = 1.2;\n\n// Q, K, V = embedding × weight\nconst Q = embeddings.map(e => parseFloat((e * Wq).toFixed(2)));\nconst K = embeddings.map(e => parseFloat((e * Wk).toFixed(2)));\nconst V = embeddings.map(e => parseFloat((e * Wv).toFixed(2)));\n\n// Attention scores = Q × K^T (outer product style)\nconst scores = Q.map(q => K.map(k => parseFloat((q * k).toFixed(2))));\n\n// Softmax for a row\nconst softmaxRow = (row) => {\n  const maxVal = Math.max(...row);\n  const exps = row.map(x => Math.exp(x - maxVal));\n  const sum = exps.reduce((a, b) => a + b, 0);\n  return exps.map(e => e / sum);\n};\n\n// Full attention output\nconst attentionOutput = (rowIdx) => {\n  const probs = softmaxRow(scores[rowIdx]);\n  return probs.reduce((sum, p, i) => sum + p * V[i], 0);\n};\n\n// Total number of blocks\nconst totalBlocks = NUM_BLOCKS * NUM_BLOCKS;\n\n// Compute flash attention state up to a certain block\nconst computeFlashState = (upToBlock) => {\n  const m = Array(N).fill(-Infinity);\n  const l = Array(N).fill(0);\n  const acc = Array(N).fill(0);\n  \n  const blocksToProcess = Math.min(upToBlock, totalBlocks);\n  \n  for (let blockIdx = 0; blockIdx < blocksToProcess; blockIdx++) {\n    const qBlock = Math.floor(blockIdx / NUM_BLOCKS);\n    const kBlock = blockIdx % NUM_BLOCKS;\n    const qStart = qBlock * BLOCK_SIZE;\n    const kStart = kBlock * BLOCK_SIZE;\n    \n    for (let i = 0; i < BLOCK_SIZE; i++) {\n      const row = qStart + i;\n      if (row >= N) continue;\n      \n      // Get block scores with bounds checking\n      const kEnd = Math.min(kStart + BLOCK_SIZE, N);\n      const blockScores = scores[row].slice(kStart, kEnd);\n      \n      if (blockScores.length === 0) continue;\n      \n      const blockMax = Math.max(...blockScores);\n      const oldMax = m[row];\n      const newMax = Math.max(oldMax, blockMax);\n      \n      const correction = oldMax === -Infinity ? 0 : Math.exp(oldMax - newMax);\n      \n      let expSum = 0, weightedSum = 0;\n      for (let j = 0; j < blockScores.length; j++) {\n        const expS = Math.exp(blockScores[j] - newMax);\n        expSum += expS;\n        weightedSum += expS * V[kStart + j];\n      }\n      \n      l[row] = correction * l[row] + expSum;\n      acc[row] = correction * acc[row] + weightedSum;\n      m[row] = newMax;\n    }\n  }\n  \n  return { m, l, acc };\n};\n\nexport default function AttentionPlayground() {\n  const [mode, setMode] = useState('standard');\n  const [step, setStep] = useState(0);\n  const [hoveredCell, setHoveredCell] = useState(null);\n  const [selectedRow, setSelectedRow] = useState(null);\n  const [playing, setPlaying] = useState(false);\n  const playRef = useRef(false);\n\n  const maxSteps = mode === 'standard' ? 6 : 5;\n\n  const reset = useCallback(() => { \n    setStep(0); \n    setPlaying(false); \n    playRef.current = false; \n  }, []);\n\n  const next = useCallback(() => setStep(s => Math.min(maxSteps, s + 1)), [maxSteps]);\n  const prev = useCallback(() => setStep(s => Math.max(0, s - 1)), []);\n\n  // Auto-play\n  useEffect(() => {\n    if (playing && step < maxSteps) {\n      playRef.current = true;\n      const timer = setTimeout(() => {\n        if (playRef.current) {\n          setStep(s => {\n            if (s >= maxSteps) {\n              setPlaying(false);\n              playRef.current = false;\n              return s;\n            }\n            return s + 1;\n          });\n        }\n      }, 1200);\n      return () => clearTimeout(timer);\n    } else if (step >= maxSteps) {\n      setPlaying(false);\n      playRef.current = false;\n    }\n  }, [playing, step, maxSteps]);\n\n  const switchMode = useCallback((m) => {\n    setMode(m);\n    setStep(0);\n    setPlaying(false);\n    playRef.current = false;\n    setSelectedRow(null);\n  }, []);\n\n  // Flash attention state - memoized for performance\n  const flashStateForComparison = useMemo(() => computeFlashState(totalBlocks), []);\n  \n  const flashState = useMemo(() => {\n    if (mode === 'flash' && step < 5) {\n      return computeFlashState(step);\n    }\n    return flashStateForComparison;\n  }, [mode, step, flashStateForComparison]);\n\n  const prevFlashState = useMemo(() => {\n    if (mode === 'flash' && step > 1 && step <= 4) {\n      return computeFlashState(step - 1);\n    }\n    return null;\n  }, [mode, step]);\n  \n  const currentBlockIdx = mode === 'flash' && step >= 1 && step <= 4 ? step - 1 : -1;\n  const currentQBlock = currentBlockIdx >= 0 ? Math.floor(currentBlockIdx / NUM_BLOCKS) : -1;\n  const currentKBlock = currentBlockIdx >= 0 ? currentBlockIdx % NUM_BLOCKS : -1;\n\n  // Check if max was updated in current block\n  const hasMaxUpdate = useMemo(() => {\n    if (!prevFlashState || !flashState) return false;\n    for (let i = 0; i < N; i++) {\n      if (flashState.m[i] > prevFlashState.m[i] && prevFlashState.m[i] !== -Infinity) {\n        return true;\n      }\n    }\n    return false;\n  }, [prevFlashState, flashState]);\n\n  // Standard attention: which row is being softmaxed\n  const softmaxingRow = mode === 'standard' && step >= 1 && step <= 4 ? step - 1 : -1;\n\n  // Memory tracking\n  const flashMemory = { block: BLOCK_SIZE * BLOCK_SIZE, state: N * 3, total: BLOCK_SIZE * BLOCK_SIZE + N * 3 };\n  const standardMemory = { scores: N * N, total: N * N };\n\n  const getStepDescription = () => {\n    if (mode === 'standard') {\n      if (step === 0) return \"Computed all attention scores at once (Q × Kᵀ). Storing full N×N matrix.\";\n      if (step >= 1 && step <= 4) return `Computing softmax for row ${step - 1} (\"${words[step-1]}\"). Need entire row to get denominator.`;\n      if (step === 5) return \"Multiplying attention weights by V to get output for each word.\";\n      return \"Done! Standard attention requires O(N²) memory for the score matrix.\";\n    } else {\n      if (step === 0) return \"Divided into 2×2 blocks. Will process one block at a time, only 4 scores in memory.\";\n      if (step >= 1 && step <= 4) {\n        const qb = Math.floor((step-1) / NUM_BLOCKS);\n        const kb = (step-1) % NUM_BLOCKS;\n        let msg = `Processing block (${qb},${kb}): rows ${qb*2}-${qb*2+1} × cols ${kb*2}-${kb*2+1}. `;\n        if (hasMaxUpdate) msg += \"New max found! Correcting previous values.\";\n        else msg += \"Updating MAX, SUM, ACC.\";\n        return msg;\n      }\n      return \"Done! Output = ACC/SUM. Same result as standard, but only O(N) memory!\";\n    }\n  };\n\n  const handleCellClick = useCallback((i, j, qb, kb) => {\n    if (mode === 'flash') {\n      const clickedBlockIdx = qb * NUM_BLOCKS + kb + 1;\n      setStep(Math.min(clickedBlockIdx, maxSteps));\n    } else {\n      if (selectedRow === i) {\n        setSelectedRow(null);\n      } else {\n        setSelectedRow(i);\n        if (step < i + 1) setStep(i + 1);\n      }\n    }\n  }, [mode, selectedRow, step, maxSteps]);\n\n  const handlePlayClick = useCallback(() => {\n    if (playing) { \n      setPlaying(false); \n      playRef.current = false; \n    } else if (step >= maxSteps) {\n      setStep(0);\n      setPlaying(true);\n    } else {\n      setPlaying(true); \n    }\n  }, [playing, step, maxSteps]);\n\n  return (\n    <div style={{ minHeight: '100vh', background: theme.colors.background, padding: '12px', fontFamily: theme.font, color: theme.colors.text }}>\n      \n      {/* Header + Mode Selection */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', flexWrap: 'wrap', gap: '8px' }}>\n        <div>\n          <div style={{ fontSize: '18px', fontWeight: '700' }}>Attention Mechanism</div>\n          <div style={{ fontSize: '11px', color: theme.colors.textSecondary }}>From sentence to output</div>\n        </div>\n        <div style={{ display: 'flex', gap: '6px' }}>\n          <button onClick={() => switchMode('standard')} style={modeBtn(mode === 'standard', theme.colors.blue)}>\n            Standard <span style={{ opacity: 0.7 }}>O(N²)</span>\n          </button>\n          <button onClick={() => switchMode('flash')} style={modeBtn(mode === 'flash', theme.colors.yellow)}>\n            Flash <span style={{ opacity: 0.7 }}>O(N)</span>\n          </button>\n        </div>\n      </div>\n\n      {/* Section 1: Sentence → Embeddings */}\n      <Section title=\"1. Input Sentence → Click a word to highlight its attention\">\n        <div style={{ display: 'flex', gap: '6px', justifyContent: 'center', flexWrap: 'wrap' }}>\n          {words.map((word, i) => (\n            <div \n              key={i} \n              style={{ textAlign: 'center', cursor: 'pointer' }}\n              onClick={() => setSelectedRow(selectedRow === i ? null : i)}\n            >\n              <div style={{ \n                padding: '8px 14px', \n                background: selectedRow === i ? theme.colors.pink : theme.colors.surfaceAlt, \n                border: `2px solid ${selectedRow === i ? theme.colors.pink : 'transparent'}`,\n                borderRadius: '8px', \n                fontSize: '15px', \n                fontWeight: '500', \n                marginBottom: '4px',\n                color: selectedRow === i ? '#000' : theme.colors.text,\n                transition: 'all 0.15s',\n              }}>\n                {word}\n              </div>\n              <div style={{ fontSize: '10px', color: theme.colors.textMuted }}>embed</div>\n              <div style={{ padding: '4px 8px', background: `${theme.colors.primary}20`, borderRadius: '4px', fontSize: '11px', color: theme.colors.primary }}>\n                {embeddings[i].toFixed(1)}\n              </div>\n            </div>\n          ))}\n        </div>\n        {selectedRow !== null && (\n          <div style={{ textAlign: 'center', marginTop: '8px', fontSize: '11px', color: theme.colors.pink }}>\n            Showing attention FROM \"{words[selectedRow]}\" → see highlighted row below\n          </div>\n        )}\n      </Section>\n\n      {/* Section 2: Q, K, V */}\n      <Section title=\"2. Create Q, K, V (all from embeddings independently)\">\n        <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', flexWrap: 'wrap', alignItems: 'flex-start' }}>\n          <VectorColumn label=\"Q (Query)\" values={Q} color={theme.colors.pink} formula={`embed × ${Wq}`} \n            highlightIdx={hoveredCell?.row ?? selectedRow} desc=\"What am I looking for?\" />\n          <VectorColumn label=\"K (Key)\" values={K} color={theme.colors.cyan} formula={`embed × ${Wk}`} \n            highlightIdx={hoveredCell?.col} desc=\"What do I contain?\" />\n          <VectorColumn label=\"V (Value)\" values={V} color={theme.colors.orange} formula={`embed × ${Wv}`} \n            highlightIdx={null} desc=\"What I output\" />\n        </div>\n        <div style={{ textAlign: 'center', marginTop: '10px', fontSize: '10px', color: theme.colors.textMuted, background: `${theme.colors.primary}15`, padding: '8px', borderRadius: '6px' }}>\n          <span style={{ color: theme.colors.text }}>Attention formula:</span> Score[i,j] = <span style={{ color: theme.colors.pink }}>Q[i]</span> × <span style={{ color: theme.colors.cyan }}>K[j]</span> → softmax → weighted sum of <span style={{ color: theme.colors.orange }}>V</span>\n        </div>\n      </Section>\n\n      {/* Section 3: Attention Scores */}\n      <Section title=\"3. Attention Scores (Q × Kᵀ) → Hover cells to see computation\">\n        <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', alignItems: 'flex-start', flexWrap: 'wrap' }}>\n          {/* Score Matrix */}\n          <div>\n            <div style={{ display: 'flex', marginLeft: '32px', marginBottom: '2px' }}>\n              {words.map((w, i) => (\n                <div key={i} style={{ width: '40px', fontSize: '9px', color: theme.colors.cyan, textAlign: 'center' }}>{w}</div>\n              ))}\n            </div>\n            <div>\n              {scores.map((row, i) => (\n                <div key={i} style={{ display: 'flex', alignItems: 'center', marginBottom: '2px' }}>\n                  <div style={{ width: '30px', fontSize: '9px', color: theme.colors.pink, textAlign: 'right', paddingRight: '2px' }}>{words[i]}</div>\n                  {row.map((score, j) => {\n                    const qb = Math.floor(i / BLOCK_SIZE), kb = Math.floor(j / BLOCK_SIZE);\n                    const blockIdx = qb * NUM_BLOCKS + kb;\n                    const isCurrentBlock = mode === 'flash' && qb === currentQBlock && kb === currentKBlock;\n                    const isProcessed = mode === 'flash' && step > 0 && blockIdx < step;\n                    const isBlockBorderTop = i % BLOCK_SIZE === 0 && i > 0;\n                    const isBlockBorderLeft = j % BLOCK_SIZE === 0 && j > 0;\n                    const isSoftmaxRow = mode === 'standard' && i === softmaxingRow;\n                    const showSoftmax = mode === 'standard' && step > i && step >= 1;\n                    const prob = showSoftmax ? softmaxRow(scores[i])[j] : null;\n                    const isSelectedRow = selectedRow === i;\n                    const isHovered = hoveredCell?.row === i && hoveredCell?.col === j;\n                    \n                    return (\n                      <div \n                        key={j} \n                        style={{\n                          width: '40px',\n                          height: '32px',\n                          display: 'flex',\n                          flexDirection: 'column',\n                          alignItems: 'center',\n                          justifyContent: 'center',\n                          background: isHovered ? theme.colors.primary\n                            : isCurrentBlock ? theme.colors.orange \n                            : isProcessed ? `${theme.colors.positive}50`\n                            : isSoftmaxRow ? `${theme.colors.blue}40`\n                            : isSelectedRow ? `${theme.colors.pink}30`\n                            : showSoftmax ? `${theme.colors.green}20`\n                            : theme.colors.surfaceAlt,\n                          borderRadius: '4px',\n                          margin: '1px',\n                          borderTop: mode === 'flash' && isBlockBorderTop ? `2px solid ${theme.colors.yellow}` : undefined,\n                          borderLeft: mode === 'flash' && isBlockBorderLeft ? `2px solid ${theme.colors.yellow}` : undefined,\n                          outline: isHovered ? `2px solid ${theme.colors.text}` : isSelectedRow ? `1px solid ${theme.colors.pink}` : 'none',\n                          fontSize: '9px',\n                          color: isCurrentBlock || isHovered ? '#000' : theme.colors.text,\n                          fontWeight: isCurrentBlock || isSoftmaxRow || isHovered ? '700' : '400',\n                          cursor: 'pointer',\n                        }}\n                        onMouseEnter={() => setHoveredCell({ row: i, col: j })}\n                        onMouseLeave={() => setHoveredCell(null)}\n                        onClick={() => handleCellClick(i, j, qb, kb)}\n                      >\n                        <div>{score.toFixed(2)}</div>\n                        {showSoftmax && <div style={{ fontSize: '8px', color: isHovered ? '#000' : theme.colors.green }}>{prob.toFixed(2)}</div>}\n                      </div>\n                    );\n                  })}\n                </div>\n              ))}\n            </div>\n            {/* Hover info */}\n            {hoveredCell && (\n              <div style={{ \n                marginTop: '8px', \n                padding: '8px', \n                background: `${theme.colors.primary}20`, \n                borderRadius: '6px',\n                fontSize: '10px',\n                textAlign: 'center',\n              }}>\n                <strong>\"{words[hoveredCell.row]}\"</strong> attending to <strong>\"{words[hoveredCell.col]}\"</strong><br/>\n                Score = Q[{hoveredCell.row}] × K[{hoveredCell.col}] = {Q[hoveredCell.row].toFixed(2)} × {K[hoveredCell.col].toFixed(2)} = <span style={{ color: theme.colors.orange, fontWeight: '700' }}>{scores[hoveredCell.row][hoveredCell.col].toFixed(2)}</span>\n                {mode === 'flash' && <div style={{ marginTop: '4px', color: theme.colors.yellow }}>Click to process this block!</div>}\n                {mode === 'standard' && <div style={{ marginTop: '4px', color: theme.colors.blue }}>Click to softmax row \"{words[hoveredCell.row]}\"</div>}\n              </div>\n            )}\n            <div style={{ fontSize: '9px', color: theme.colors.textMuted, marginTop: '4px', textAlign: 'center' }}>\n              {mode === 'standard' && step >= 1 && <span><span style={{ color: theme.colors.green }}>■</span> softmax applied</span>}\n              {mode === 'flash' && <><span style={{ color: theme.colors.orange }}>■</span> current <span style={{ color: theme.colors.positive, marginLeft: '6px' }}>■</span> done</>}\n            </div>\n          </div>\n\n          {/* Standard: show memory + output */}\n          {mode === 'standard' && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>\n              <div style={{ padding: '10px', background: `${theme.colors.negative}15`, border: `1px solid ${theme.colors.negative}40`, borderRadius: '8px', textAlign: 'center' }}>\n                <div style={{ fontSize: '9px', color: theme.colors.negative }}>Memory</div>\n                <div style={{ fontSize: '16px', fontWeight: '700' }}>{N}×{N} = {N*N}</div>\n                <div style={{ fontSize: '9px', color: theme.colors.textMuted }}>scores stored</div>\n              </div>\n              {step >= 5 && (\n                <div style={{ \n                  padding: '12px', \n                  background: `${theme.colors.blue}20`, \n                  border: `2px solid ${theme.colors.blue}`, \n                  borderRadius: '10px',\n                }}>\n                  <div style={{ fontSize: '11px', color: theme.colors.blue, fontWeight: '600', marginBottom: '6px', textAlign: 'center' }}>\n                    ✓ Final Output (Σ prob × V)\n                  </div>\n                  {words.map((w, i) => (\n                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', padding: '3px 0' }}>\n                      <span style={{ color: theme.colors.text }}>{w}:</span>\n                      <span style={{ color: theme.colors.orange, fontWeight: '700', fontSize: '13px' }}>{attentionOutput(i).toFixed(3)}</span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Flash: show running state */}\n          {mode === 'flash' && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>\n              <div style={{ padding: '10px', background: `${theme.colors.positive}15`, border: `1px solid ${theme.colors.positive}40`, borderRadius: '8px', textAlign: 'center' }}>\n                <div style={{ fontSize: '9px', color: theme.colors.positive }}>Memory</div>\n                <div style={{ fontSize: '16px', fontWeight: '700' }}>{BLOCK_SIZE}×{BLOCK_SIZE} = {BLOCK_SIZE*BLOCK_SIZE}</div>\n                <div style={{ fontSize: '9px', color: theme.colors.textMuted }}>+ {N}×3 state</div>\n              </div>\n              <div style={{ padding: '8px', background: theme.colors.surfaceAlt, borderRadius: '8px', fontSize: '9px' }}>\n                <div style={{ display: 'flex', gap: '2px', marginBottom: '4px', color: theme.colors.textMuted }}>\n                  <div style={{ width: '28px' }}>row</div>\n                  <div style={{ width: '36px', textAlign: 'center', color: theme.colors.yellow }}>MAX</div>\n                  <div style={{ width: '36px', textAlign: 'center', color: theme.colors.blue }}>SUM</div>\n                  <div style={{ width: '40px', textAlign: 'center', color: theme.colors.pink }}>ACC</div>\n                </div>\n                {words.map((w, i) => {\n                  const isActive = Math.floor(i / BLOCK_SIZE) === currentQBlock;\n                  return (\n                    <div key={i} style={{ \n                      display: 'flex', \n                      gap: '2px', \n                      padding: '2px',\n                      background: isActive ? `${theme.colors.orange}20` : 'transparent',\n                      borderRadius: '2px',\n                    }}>\n                      <div style={{ width: '28px', color: theme.colors.textMuted }}>{w}</div>\n                      <div style={{ width: '36px', textAlign: 'center' }}>\n                        {flashState.m[i] === -Infinity ? '-∞' : flashState.m[i].toFixed(2)}\n                      </div>\n                      <div style={{ width: '36px', textAlign: 'center' }}>\n                        {flashState.l[i].toFixed(2)}\n                      </div>\n                      <div style={{ width: '40px', textAlign: 'center' }}>\n                        {flashState.acc[i].toFixed(2)}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n              \n              {/* Final Output - prominent display when done */}\n              {step >= 5 && (\n                <div style={{ \n                  padding: '12px', \n                  background: `${theme.colors.positive}20`, \n                  border: `2px solid ${theme.colors.positive}`, \n                  borderRadius: '10px',\n                }}>\n                  <div style={{ fontSize: '11px', color: theme.colors.positive, fontWeight: '600', marginBottom: '6px', textAlign: 'center' }}>\n                    ✓ Final Output = ACC / SUM\n                  </div>\n                  {words.map((w, i) => (\n                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', padding: '3px 0' }}>\n                      <span style={{ color: theme.colors.text }}>{w}:</span>\n                      <span style={{ color: theme.colors.orange, fontWeight: '700', fontSize: '13px' }}>\n                        {flashState.l[i] > 0 ? (flashState.acc[i] / flashState.l[i]).toFixed(3) : '0'}\n                      </span>\n                    </div>\n                  ))}\n                  <div style={{ marginTop: '8px', fontSize: '10px', color: theme.colors.textSecondary, textAlign: 'center' }}>\n                    Same result as standard attention! ✓\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n      </Section>\n\n      {/* Section 4: Side-by-side comparison when either is done */}\n      {((mode === 'standard' && step >= 6) || (mode === 'flash' && step >= 5)) && (\n        <Section title=\"4. Verify: Both methods produce identical results!\">\n          <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', flexWrap: 'wrap' }}>\n            {/* Softmax probabilities comparison */}\n            <div>\n              <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginBottom: '6px', textAlign: 'center' }}>\n                Softmax Probabilities (row = query word)\n              </div>\n              <div style={{ background: theme.colors.surfaceAlt, borderRadius: '8px', padding: '8px' }}>\n                <div style={{ display: 'flex', marginLeft: '32px', marginBottom: '4px' }}>\n                  {words.map((w, i) => (\n                    <div key={i} style={{ width: '44px', fontSize: '8px', color: theme.colors.cyan, textAlign: 'center' }}>{w}</div>\n                  ))}\n                </div>\n                {words.map((word, i) => {\n                  const stdProbs = softmaxRow(scores[i]);\n                  return (\n                    <div key={i} style={{ display: 'flex', alignItems: 'center', marginBottom: '2px' }}>\n                      <div style={{ width: '30px', fontSize: '8px', color: theme.colors.pink, textAlign: 'right', paddingRight: '2px' }}>{word}</div>\n                      {stdProbs.map((prob, j) => (\n                        <div key={j} style={{\n                          width: '44px',\n                          height: '24px',\n                          display: 'flex',\n                          alignItems: 'center',\n                          justifyContent: 'center',\n                          background: `rgba(16, 185, 129, ${prob})`,\n                          borderRadius: '3px',\n                          margin: '1px',\n                          fontSize: '9px',\n                          color: prob > 0.3 ? '#000' : theme.colors.text,\n                        }}>\n                          {prob.toFixed(2)}\n                        </div>\n                      ))}\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n\n            {/* Final outputs comparison */}\n            <div>\n              <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginBottom: '6px', textAlign: 'center' }}>\n                Final Outputs Comparison\n              </div>\n              <div style={{ background: theme.colors.surfaceAlt, borderRadius: '8px', padding: '10px' }}>\n                <div style={{ display: 'flex', gap: '8px', marginBottom: '6px', fontSize: '9px', color: theme.colors.textMuted }}>\n                  <div style={{ width: '32px' }}>Word</div>\n                  <div style={{ width: '60px', textAlign: 'center', color: theme.colors.blue }}>Standard</div>\n                  <div style={{ width: '60px', textAlign: 'center', color: theme.colors.yellow }}>Flash</div>\n                  <div style={{ width: '36px', textAlign: 'center' }}>Match?</div>\n                </div>\n                {words.map((w, i) => {\n                  const stdOutput = attentionOutput(i);\n                  const flashOutput = flashStateForComparison.l[i] > 0 ? flashStateForComparison.acc[i] / flashStateForComparison.l[i] : 0;\n                  const match = Math.abs(stdOutput - flashOutput) < 0.001;\n                  return (\n                    <div key={i} style={{ display: 'flex', gap: '8px', padding: '4px 0', fontSize: '11px', borderBottom: i < words.length - 1 ? `1px solid ${theme.colors.border}` : 'none' }}>\n                      <div style={{ width: '32px', color: theme.colors.textMuted }}>{w}</div>\n                      <div style={{ width: '60px', textAlign: 'center', color: theme.colors.blue, fontWeight: '600' }}>{stdOutput.toFixed(3)}</div>\n                      <div style={{ width: '60px', textAlign: 'center', color: theme.colors.yellow, fontWeight: '600' }}>{flashOutput.toFixed(3)}</div>\n                      <div style={{ width: '36px', textAlign: 'center', color: match ? theme.colors.positive : theme.colors.negative }}>\n                        {match ? '✓' : '✗'}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n              <div style={{ marginTop: '8px', padding: '8px', background: `${theme.colors.positive}20`, borderRadius: '6px', textAlign: 'center' }}>\n                <div style={{ fontSize: '12px', color: theme.colors.positive, fontWeight: '600' }}>\n                  ✓ Identical results!\n                </div>\n                <div style={{ fontSize: '10px', color: theme.colors.textSecondary, marginTop: '2px' }}>\n                  Flash uses {flashMemory.total} values vs Standard's {standardMemory.total}\n                </div>\n              </div>\n            </div>\n          </div>\n        </Section>\n      )}\n\n      {/* Step Description */}\n      <div style={{ \n        padding: '10px 14px', \n        background: theme.colors.surface, \n        borderRadius: '8px', \n        borderLeft: `3px solid ${mode === 'standard' ? theme.colors.blue : theme.colors.yellow}`,\n        marginBottom: '10px',\n        fontSize: '12px',\n        color: theme.colors.textSecondary,\n        lineHeight: 1.5,\n      }}>\n        <strong style={{ color: theme.colors.text }}>Step {step}/{maxSteps}:</strong> {getStepDescription()}\n        {hasMaxUpdate && <span style={{ color: theme.colors.yellow, marginLeft: '6px' }}>⚡ Correction applied!</span>}\n      </div>\n\n      {/* Navigation */}\n      <div style={{ display: 'flex', gap: '8px', justifyContent: 'center', marginBottom: '12px' }}>\n        <button onClick={prev} disabled={step === 0 || playing} style={navBtn(step === 0 || playing)}>←</button>\n        <button \n          onClick={handlePlayClick} \n          style={{ \n            ...navBtn(false), \n            background: playing ? theme.colors.negative : theme.colors.positive,\n            color: '#fff',\n            minWidth: '70px',\n          }}\n        >\n          {playing ? '⏸' : '▶'}\n        </button>\n        <button onClick={next} disabled={step >= maxSteps || playing} style={{ \n          ...navBtn(step >= maxSteps || playing), \n          background: (step >= maxSteps || playing) ? theme.colors.border : (mode === 'standard' ? theme.colors.blue : theme.colors.yellow),\n          color: (step >= maxSteps || playing) ? theme.colors.textMuted : '#fff',\n          minWidth: '80px',\n        }}>\n          {step >= maxSteps ? '✓ Done' : 'Next →'}\n        </button>\n        <button onClick={reset} style={navBtn(false)}>↺</button>\n      </div>\n\n      {/* Complexity Comparison */}\n      <div style={{ background: theme.colors.surface, borderRadius: '10px', padding: '12px' }}>\n        <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap', marginBottom: '10px' }}>\n          <ComplexityBox \n            title=\"Standard Attention\" \n            memory=\"O(N²)\" \n            time=\"O(N²)\" \n            color={theme.colors.blue}\n            active={mode === 'standard'}\n            note=\"Stores full N×N matrix\"\n          />\n          <ComplexityBox \n            title=\"Flash Attention\" \n            memory=\"O(N)\" \n            time=\"O(N²)\" \n            color={theme.colors.yellow}\n            active={mode === 'flash'}\n            note=\"Same time, less memory!\"\n          />\n        </div>\n        <div style={{ fontSize: '10px', color: theme.colors.textMuted, textAlign: 'center', lineHeight: 1.6 }}>\n          <strong style={{ color: theme.colors.yellow }}>Flash trick:</strong> Track running MAX, SUM, ACC per row. When new block has higher max, correct with <code style={{ color: theme.colors.cyan }}>exp(old_max - new_max)</code>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction Section({ title, children }) {\n  return (\n    <div style={{ background: theme.colors.surface, borderRadius: '10px', padding: '12px', marginBottom: '10px' }}>\n      <div style={{ fontSize: '11px', color: theme.colors.textMuted, marginBottom: '8px', fontWeight: '600' }}>{title}</div>\n      {children}\n    </div>\n  );\n}\n\nfunction VectorColumn({ label, values, color, formula, highlightIdx, desc }) {\n  return (\n    <div style={{ textAlign: 'center' }}>\n      <div style={{ fontSize: '11px', color, fontWeight: '600', marginBottom: '2px' }}>{label}</div>\n      <div style={{ fontSize: '9px', color: theme.colors.textMuted, marginBottom: '4px' }}>{formula}</div>\n      <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>\n        {values.map((v, i) => (\n          <div key={i} style={{\n            padding: '4px 10px',\n            background: highlightIdx === i ? color : `${color}20`,\n            border: `1px solid ${highlightIdx === i ? color : `${color}40`}`,\n            borderRadius: '4px',\n            fontSize: '11px',\n            color: highlightIdx === i ? '#000' : theme.colors.text,\n            fontWeight: highlightIdx === i ? '700' : '400',\n          }}>\n            {v.toFixed(2)}\n          </div>\n        ))}\n      </div>\n      <div style={{ fontSize: '8px', color: theme.colors.textMuted, marginTop: '4px' }}>{desc}</div>\n    </div>\n  );\n}\n\nfunction ComplexityBox({ title, memory, time, color, active, note }) {\n  return (\n    <div style={{\n      padding: '10px 16px',\n      background: active ? `${color}20` : theme.colors.surfaceAlt,\n      border: `2px solid ${active ? color : theme.colors.border}`,\n      borderRadius: '10px',\n      textAlign: 'center',\n      minWidth: '130px',\n    }}>\n      <div style={{ fontSize: '11px', color, fontWeight: '600' }}>{title}</div>\n      <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', marginTop: '6px' }}>\n        <div>\n          <div style={{ fontSize: '9px', color: theme.colors.textMuted }}>Memory</div>\n          <div style={{ fontSize: '16px', fontWeight: '700' }}>{memory}</div>\n        </div>\n        <div>\n          <div style={{ fontSize: '9px', color: theme.colors.textMuted }}>Time</div>\n          <div style={{ fontSize: '16px', fontWeight: '700' }}>{time}</div>\n        </div>\n      </div>\n      <div style={{ fontSize: '9px', color: theme.colors.textMuted, marginTop: '4px' }}>{note}</div>\n    </div>\n  );\n}\n\nconst modeBtn = (active, color) => ({\n  padding: '8px 14px',\n  background: active ? color : theme.colors.surface,\n  border: `2px solid ${color}`,\n  borderRadius: '8px',\n  color: active ? '#000' : color,\n  fontFamily: theme.font,\n  fontSize: '12px',\n  fontWeight: '600',\n  cursor: 'pointer',\n});\n\nconst navBtn = (disabled) => ({\n  padding: '10px 16px',\n  background: disabled ? theme.colors.border : theme.colors.surface,\n  border: 'none',\n  borderRadius: '8px',\n  color: disabled ? theme.colors.textMuted : theme.colors.text,\n  fontFamily: theme.font,\n  fontSize: '13px',\n  cursor: disabled ? 'not-allowed' : 'pointer',\n});\n",
  "settings": {
    "editorHeight": 600,
    "showPreview": true,
    "theme": "auto",
    "showEditor": false,
    "editorWidthPercentage": 35,
    "showConsole": false
  },
  "dependencies": {}
}