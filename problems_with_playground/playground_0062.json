{
  "problem_id": 62,
  "title": "Implement a Simple RNN with Backpropagation Through Time (BPTT)",
  "category": "Deep Learning",
  "enabled": true,
  "type": "react",
  "code": "\nimport React, { useState, useEffect } from 'react';\n\nconst theme = {\n  bg: '#0f172a',\n  surface: '#1e293b',\n  card: '#334155',\n  border: '#475569',\n  text: '#f8fafc',\n  muted: '#94a3b8',\n  dim: '#64748b',\n  input: '#38bdf8',\n  hidden: '#a78bfa',\n  output: '#4ade80',\n  weight: '#fbbf24',\n  gradient: '#f472b6',\n  error: '#f87171',\n};\n\nconst tanh = x => Math.tanh(x);\nconst tanhDeriv = x => 1 - Math.tanh(x) ** 2;\n\nexport default function App() {\n  const [mode, setMode] = useState('learn');\n  const [forwardStep, setForwardStep] = useState(0);\n  const [backwardStep, setBackwardStep] = useState(0);\n  const [selectedComponent, setSelectedComponent] = useState(null);\n  const [epoch, setEpoch] = useState(0);\n  const [isTraining, setIsTraining] = useState(false);\n\n  const [weights, setWeights] = useState({\n    W_xh: 0.5, W_hh: 0.3, W_hy: 0.4, b_h: 0.1, b_y: 0.1,\n  });\n\n  const inputSeq = [1, 2, 3, 4];\n  const targetSeq = [2, 3, 4, 5];\n\n  const computeForward = () => {\n    const hiddens = [0];\n    const outputs = [];\n    const preActivations = [];\n    for (let t = 0; t < inputSeq.length; t++) {\n      const x = inputSeq[t];\n      const h_prev = hiddens[t];\n      const pre = weights.W_xh * x + weights.W_hh * h_prev + weights.b_h;\n      const h = tanh(pre);\n      const y = weights.W_hy * h + weights.b_y;\n      preActivations.push(pre);\n      hiddens.push(h);\n      outputs.push(y);\n    }\n    return { hiddens, outputs, preActivations };\n  };\n\n  const { hiddens, outputs, preActivations } = computeForward();\n  const loss = outputs.reduce((sum, y, t) => sum + 0.5 * (y - targetSeq[t]) ** 2, 0);\n\n  const computeGradients = () => {\n    const grads = [];\n    let dh_next = 0;\n    for (let t = inputSeq.length - 1; t >= 0; t--) {\n      const dy = outputs[t] - targetSeq[t];\n      const dh_from_output = weights.W_hy * dy;\n      const dh_total = dh_from_output + dh_next;\n      const dh_raw = dh_total * tanhDeriv(preActivations[t]);\n      grads.unshift({\n        t, dy, dh_from_output, dh_from_future: dh_next, dh_total, dh_raw,\n        dW_xh: dh_raw * inputSeq[t],\n        dW_hh: dh_raw * hiddens[t],\n        dW_hy: dy * hiddens[t + 1],\n      });\n      dh_next = weights.W_hh * dh_raw;\n    }\n    return grads;\n  };\n\n  const gradients = computeGradients();\n\n  const trainStep = () => {\n    const lr = 0.05;\n    let dW_xh = 0, dW_hh = 0, dW_hy = 0, db_h = 0, db_y = 0;\n    gradients.forEach(g => {\n      dW_xh += g.dW_xh; dW_hh += g.dW_hh; dW_hy += g.dW_hy;\n      db_h += g.dh_raw; db_y += g.dy;\n    });\n    setWeights(w => ({\n      W_xh: w.W_xh - lr * dW_xh, W_hh: w.W_hh - lr * dW_hh, W_hy: w.W_hy - lr * dW_hy,\n      b_h: w.b_h - lr * db_h, b_y: w.b_y - lr * db_y,\n    }));\n    setEpoch(e => e + 1);\n  };\n\n  useEffect(() => {\n    if (isTraining) {\n      const timer = setInterval(trainStep, 300);\n      return () => clearInterval(timer);\n    }\n  }, [isTraining, weights]);\n\n  const reset = () => {\n    setWeights({ W_xh: 0.5, W_hh: 0.3, W_hy: 0.4, b_h: 0.1, b_y: 0.1 });\n    setEpoch(0); setForwardStep(0); setBackwardStep(0); setIsTraining(false);\n  };\n\n  const componentInfo = {\n    input: { title: \"Input (x)\", color: theme.input, desc: \"The input value at this timestep. Fed into the network.\" },\n    hidden: { title: \"Hidden State (h)\", color: theme.hidden, desc: \"The 'memory' of the RNN. Combines current input with previous hidden state.\" },\n    output: { title: \"Output (≈∑)\", color: theme.output, desc: \"The prediction. Compared against target to compute error.\" },\n    W_xh: { title: \"Input ‚Üí Hidden Weight\", color: theme.weight, desc: \"Transforms input into hidden space. SAME weight used at ALL timesteps!\" },\n    W_hh: { title: \"Hidden ‚Üí Hidden Weight\", color: theme.weight, desc: \"Passes information between timesteps. This is what makes it 'recurrent'!\" },\n    W_hy: { title: \"Hidden ‚Üí Output Weight\", color: theme.weight, desc: \"Transforms hidden state to output prediction.\" },\n    tanh: { title: \"Tanh Activation\", color: theme.hidden, desc: \"Squashes values to [-1, 1]. Adds non-linearity. Derivative: 1 - tanh¬≤(x)\" },\n  };\n\n  return (\n    <div style={styles.container}>\n      <div style={styles.header}>\n        <h1 style={styles.title}>RNN & Backprop Through Time</h1>\n        <p style={styles.subtitle}>Step through forward & backward passes</p>\n      </div>\n\n      <div style={styles.modeTabs}>\n        {[\n          { key: 'learn', label: 'üìö Learn' },\n          { key: 'forward', label: '‚û°Ô∏è Forward' },\n          { key: 'backward', label: '‚¨ÖÔ∏è Backward' },\n          { key: 'train', label: 'üèãÔ∏è Train' },\n        ].map(m => (\n          <div key={m.key} onClick={() => { setMode(m.key); setForwardStep(0); setBackwardStep(0); }}\n            style={{...styles.modeTab, background: mode === m.key ? theme.output : theme.card, color: mode === m.key ? '#000' : theme.muted}}>\n            <div style={styles.modeLabel}>{m.label}</div>\n          </div>\n        ))}\n      </div>\n\n      <div style={styles.taskBar}>\n        Input: [{inputSeq.join(', ')}] ‚Üí Target: [{targetSeq.join(', ')}]\n        <span style={{marginLeft: 'auto', color: loss < 0.5 ? theme.output : theme.error}}>Loss: {loss.toFixed(3)}</span>\n      </div>\n\n      <div style={styles.vizContainer}>\n        <svg width=\"100%\" viewBox=\"0 0 500 280\" style={{display: 'block'}}>\n          <text x=\"250\" y=\"18\" textAnchor=\"middle\" fill={theme.weight} fontSize=\"10\" fontWeight=\"600\">\n            ‚ö†Ô∏è Same weights used at ALL timesteps (this is key!)\n          </text>\n\n          {inputSeq.map((x, t) => {\n            const cx = 70 + t * 110;\n            const isForwardActive = mode === 'forward' && forwardStep >= t + 1;\n            const isBackwardActive = mode === 'backward' && backwardStep >= (inputSeq.length - t);\n            const isActive = mode === 'learn' || mode === 'train' || isForwardActive;\n            const showGradient = isBackwardActive;\n\n            return (\n              <g key={t}>\n                <text x={cx} y=\"38\" textAnchor=\"middle\" fill={theme.dim} fontSize=\"10\">t={t+1}</text>\n\n                <g onClick={() => setSelectedComponent('input')} style={{cursor: 'pointer'}}>\n                  <circle cx={cx} cy=\"60\" r=\"18\" fill={isActive ? theme.input : theme.card} opacity={isActive ? 1 : 0.3} />\n                  <text x={cx} y=\"65\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"14\" fontWeight=\"700\">{x}</text>\n                  <text x={cx} y=\"52\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"8\">x</text>\n                </g>\n\n                <line x1={cx} y1=\"80\" x2={cx} y2=\"110\" stroke={isActive ? theme.weight : theme.card} strokeWidth=\"2\" />\n                {isActive && <text x={cx + 12} y=\"98\" fill={theme.weight} fontSize=\"8\" onClick={() => setSelectedComponent('W_xh')} style={{cursor: 'pointer'}}>W_xh</text>}\n\n                <g onClick={() => setSelectedComponent('hidden')} style={{cursor: 'pointer'}}>\n                  <circle cx={cx} cy=\"130\" r=\"22\" fill={isActive ? theme.hidden : theme.card} opacity={isActive ? 1 : 0.3} />\n                  <text x={cx} y=\"127\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"8\">h{t+1}</text>\n                  <text x={cx} y=\"138\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"11\" fontWeight=\"600\">\n                    {isActive ? hiddens[t + 1].toFixed(2) : '?'}\n                  </text>\n                </g>\n\n                {isActive && <text x={cx + 26} y=\"130\" fill={theme.hidden} fontSize=\"8\" fontStyle=\"italic\" onClick={() => setSelectedComponent('tanh')} style={{cursor: 'pointer'}}>tanh</text>}\n\n                <line x1={cx} y1=\"154\" x2={cx} y2=\"184\" stroke={isActive ? theme.weight : theme.card} strokeWidth=\"2\" />\n                {isActive && <text x={cx + 12} y=\"172\" fill={theme.weight} fontSize=\"8\" onClick={() => setSelectedComponent('W_hy')} style={{cursor: 'pointer'}}>W_hy</text>}\n\n                <g onClick={() => setSelectedComponent('output')} style={{cursor: 'pointer'}}>\n                  <circle cx={cx} cy=\"205\" r=\"18\" fill={isActive ? theme.output : theme.card} opacity={isActive ? 1 : 0.3} />\n                  <text x={cx} y=\"202\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"8\">≈∑</text>\n                  <text x={cx} y=\"213\" textAnchor=\"middle\" fill={isActive ? '#000' : theme.dim} fontSize=\"10\" fontWeight=\"600\">\n                    {isActive ? outputs[t].toFixed(2) : '?'}\n                  </text>\n                </g>\n\n                <text x={cx} y=\"235\" textAnchor=\"middle\" fill={theme.dim} fontSize=\"9\">target: {targetSeq[t]}</text>\n                {isActive && (\n                  <text x={cx} y=\"248\" textAnchor=\"middle\" fill={Math.abs(outputs[t] - targetSeq[t]) < 0.5 ? theme.output : theme.error} fontSize=\"9\" fontWeight=\"600\">\n                    err: {(outputs[t] - targetSeq[t]).toFixed(2)}\n                  </text>\n                )}\n\n                {t < inputSeq.length - 1 && (\n                  <g onClick={() => setSelectedComponent('W_hh')} style={{cursor: 'pointer'}}>\n                    <line x1={cx + 24} y1=\"130\" x2={cx + 86} y2=\"130\" stroke={isActive ? theme.weight : theme.card} strokeWidth=\"2\" strokeDasharray={isActive ? \"0\" : \"4\"} />\n                    <polygon points={`${cx + 83},125 ${cx + 93},130 ${cx + 83},135`} fill={isActive ? theme.weight : theme.card} />\n                    <text x={cx + 55} y=\"122\" textAnchor=\"middle\" fill={theme.weight} fontSize=\"8\">W_hh</text>\n                  </g>\n                )}\n\n                {showGradient && (\n                  <>\n                    <line x1={cx - 8} y1=\"188\" x2={cx - 8} y2=\"158\" stroke={theme.gradient} strokeWidth=\"2\" strokeDasharray=\"4\" />\n                    <polygon points={`${cx - 12},161 ${cx - 8},151 ${cx - 4},161`} fill={theme.gradient} />\n                    <rect x={cx - 35} y=\"260\" width=\"70\" height=\"18\" rx=\"4\" fill={theme.gradient} />\n                    <text x={cx} y=\"273\" textAnchor=\"middle\" fill=\"#000\" fontSize=\"9\" fontWeight=\"600\">‚àá = {gradients[t]?.dh_raw.toFixed(3)}</text>\n                    {t > 0 && <line x1={cx - 24} y1=\"135\" x2={cx - 70} y2=\"135\" stroke={theme.gradient} strokeWidth=\"2\" strokeDasharray=\"4\" />}\n                  </>\n                )}\n              </g>\n            );\n          })}\n\n          <g>\n            <circle cx=\"25\" cy=\"130\" r=\"14\" fill={theme.card} stroke={theme.hidden} strokeWidth=\"1\" />\n            <text x=\"25\" y=\"133\" textAnchor=\"middle\" fill={theme.dim} fontSize=\"9\">h‚ÇÄ=0</text>\n          </g>\n          <line x1=\"40\" y1=\"130\" x2=\"46\" y2=\"130\" stroke={theme.hidden} strokeWidth=\"1\" strokeDasharray=\"2\" />\n        </svg>\n      </div>\n\n      {mode === 'forward' && (\n        <div style={styles.stepControl}>\n          <div style={styles.stepLabel}>\n            {forwardStep === 0 ? 'Press Next to start forward pass' : \n             forwardStep <= inputSeq.length ? `Computing timestep ${forwardStep}...` : 'Forward pass complete!'}\n          </div>\n          <div style={styles.stepButtons}>\n            <button onClick={() => setForwardStep(0)} style={styles.btn}>Reset</button>\n            <button onClick={() => setForwardStep(s => Math.min(s + 1, inputSeq.length + 1))} \n              style={{...styles.btn, background: theme.input, color: '#000'}} disabled={forwardStep > inputSeq.length}>Next ‚Üí</button>\n          </div>\n          {forwardStep > 0 && forwardStep <= inputSeq.length && (\n            <div style={styles.stepFormula}>\n              <div>h{forwardStep} = tanh({weights.W_xh.toFixed(2)} √ó {inputSeq[forwardStep-1]} + {weights.W_hh.toFixed(2)} √ó {hiddens[forwardStep-1].toFixed(2)} + {weights.b_h.toFixed(2)})</div>\n              <div style={{color: theme.hidden}}>h{forwardStep} = {hiddens[forwardStep].toFixed(4)}</div>\n              <div style={{marginTop: 4}}>≈∑{forwardStep} = {weights.W_hy.toFixed(2)} √ó {hiddens[forwardStep].toFixed(2)} + {weights.b_y.toFixed(2)}</div>\n              <div style={{color: theme.output}}>≈∑{forwardStep} = {outputs[forwardStep-1].toFixed(4)}</div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {mode === 'backward' && (\n        <div style={styles.stepControl}>\n          <div style={styles.stepLabel}>\n            {backwardStep === 0 ? 'Press Next to start backward pass (from t=4 to t=1)' : \n             backwardStep <= inputSeq.length ? `Computing gradients at t=${inputSeq.length - backwardStep + 1}...` : 'BPTT complete!'}\n          </div>\n          <div style={styles.stepButtons}>\n            <button onClick={() => setBackwardStep(0)} style={styles.btn}>Reset</button>\n            <button onClick={() => setBackwardStep(s => Math.min(s + 1, inputSeq.length + 1))} \n              style={{...styles.btn, background: theme.gradient, color: '#000'}} disabled={backwardStep > inputSeq.length}>Next ‚Üê</button>\n          </div>\n          {backwardStep > 0 && backwardStep <= inputSeq.length && (\n            <div style={styles.stepFormula}>\n              {(() => {\n                const t = inputSeq.length - backwardStep;\n                const g = gradients[t];\n                return (\n                  <>\n                    <div>Output error: dy = {outputs[t].toFixed(2)} - {targetSeq[t]} = <span style={{color: theme.error}}>{g.dy.toFixed(3)}</span></div>\n                    <div>Gradient from output: {g.dh_from_output.toFixed(3)}</div>\n                    <div>Gradient from future: <span style={{color: theme.gradient}}>{g.dh_from_future.toFixed(3)}</span></div>\n                    <div>Total √ó tanh': <span style={{color: theme.gradient}}>{g.dh_raw.toFixed(3)}</span></div>\n                  </>\n                );\n              })()}\n            </div>\n          )}\n        </div>\n      )}\n\n      {mode === 'train' && (\n        <div style={styles.stepControl}>\n          <div style={styles.trainHeader}>\n            <span>Epoch: {epoch}</span>\n            <span style={{color: loss < 0.5 ? theme.output : loss < 2 ? theme.weight : theme.error}}>Loss: {loss.toFixed(4)}</span>\n          </div>\n          <div style={styles.lossBar}><div style={{...styles.lossBarFill, width: `${Math.max(0, (1 - loss / 5) * 100)}%`}} /></div>\n          <div style={styles.stepButtons}>\n            <button onClick={reset} style={styles.btn}>Reset</button>\n            <button onClick={trainStep} style={styles.btn}>Step</button>\n            <button onClick={() => setIsTraining(!isTraining)} style={{...styles.btn, background: isTraining ? theme.error : theme.output, color: '#000'}}>\n              {isTraining ? '‚èπ Stop' : '‚ñ∂ Train'}\n            </button>\n          </div>\n          <div style={styles.weightsDisplay}>\n            <span>W_xh: {weights.W_xh.toFixed(3)}</span>\n            <span>W_hh: {weights.W_hh.toFixed(3)}</span>\n            <span>W_hy: {weights.W_hy.toFixed(3)}</span>\n          </div>\n        </div>\n      )}\n\n      {mode === 'learn' && (\n        <div style={styles.learnBox}>\n          <div style={styles.learnTitle}>üëÜ Click any component above to learn about it</div>\n          <div style={styles.learnGrid}>\n            {['input', 'hidden', 'output', 'W_xh', 'W_hh', 'W_hy'].map(key => (\n              <div key={key} onClick={() => setSelectedComponent(key)}\n                style={{...styles.learnItem, borderColor: componentInfo[key].color, background: selectedComponent === key ? `${componentInfo[key].color}20` : 'transparent'}}>\n                <div style={{color: componentInfo[key].color, fontWeight: 600, fontSize: 11}}>{key}</div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {selectedComponent && componentInfo[selectedComponent] && (\n        <div style={{...styles.infoPanel, borderColor: componentInfo[selectedComponent].color}}>\n          <div style={styles.infoPanelHeader}>\n            <span style={{color: componentInfo[selectedComponent].color, fontWeight: 700}}>{componentInfo[selectedComponent].title}</span>\n            <button onClick={() => setSelectedComponent(null)} style={styles.closeBtn}>√ó</button>\n          </div>\n          <div style={styles.infoPanelText}>{componentInfo[selectedComponent].desc}</div>\n        </div>\n      )}\n\n      <div style={styles.insightBox}>\n        <div style={styles.insightTitle}>üí° The Key Insight</div>\n        <div style={styles.insightText}>\n          In BPTT, gradients flow backward through time. The gradient at t=1 includes error signals from t=2, t=3, and t=4!\n        </div>\n        <div style={styles.insightHighlight}>Same weights ‚Üí gradients ACCUMULATE across all timesteps before updating</div>\n      </div>\n    </div>\n  );\n}\n\nconst styles = {\n  container: { fontFamily: \"'Inter', -apple-system, sans-serif\", background: theme.bg, color: theme.text, padding: 16, maxWidth: 540, margin: '0 auto', minHeight: '100vh' },\n  header: { textAlign: 'center', marginBottom: 12 },\n  title: { fontSize: 20, fontWeight: 700, margin: 0 },\n  subtitle: { fontSize: 11, color: theme.muted, margin: '4px 0 0' },\n  modeTabs: { display: 'flex', gap: 6, marginBottom: 12 },\n  modeTab: { flex: 1, padding: '10px 8px', borderRadius: 8, textAlign: 'center', cursor: 'pointer' },\n  modeLabel: { fontSize: 11, fontWeight: 600 },\n  taskBar: { display: 'flex', alignItems: 'center', gap: 10, background: theme.surface, borderRadius: 8, padding: '8px 12px', marginBottom: 12, fontSize: 11, color: theme.muted },\n  vizContainer: { background: theme.surface, borderRadius: 12, padding: 8, marginBottom: 12 },\n  stepControl: { background: theme.surface, borderRadius: 12, padding: 14, marginBottom: 12 },\n  stepLabel: { fontSize: 12, color: theme.muted, marginBottom: 10, textAlign: 'center' },\n  stepButtons: { display: 'flex', gap: 10, justifyContent: 'center', marginBottom: 10 },\n  btn: { padding: '8px 16px', borderRadius: 8, border: 'none', background: theme.card, color: theme.text, cursor: 'pointer', fontSize: 12, fontWeight: 600 },\n  stepFormula: { background: theme.card, borderRadius: 8, padding: 12, fontSize: 11, fontFamily: 'monospace', color: theme.muted, lineHeight: 1.8 },\n  trainHeader: { display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 13 },\n  lossBar: { height: 8, background: theme.card, borderRadius: 4, marginBottom: 12, overflow: 'hidden' },\n  lossBarFill: { height: '100%', background: theme.output, borderRadius: 4, transition: 'width 0.3s' },\n  weightsDisplay: { display: 'flex', justifyContent: 'space-around', fontSize: 10, color: theme.weight, fontFamily: 'monospace' },\n  learnBox: { background: theme.surface, borderRadius: 12, padding: 14, marginBottom: 12 },\n  learnTitle: { fontSize: 12, color: theme.muted, marginBottom: 10, textAlign: 'center' },\n  learnGrid: { display: 'flex', flexWrap: 'wrap', gap: 8, justifyContent: 'center' },\n  learnItem: { padding: '8px 14px', borderRadius: 8, border: '2px solid', cursor: 'pointer' },\n  infoPanel: { background: theme.surface, borderRadius: 12, padding: 14, marginBottom: 12, borderLeft: '4px solid' },\n  infoPanelHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 },\n  closeBtn: { width: 24, height: 24, borderRadius: 12, border: 'none', background: theme.card, color: theme.text, cursor: 'pointer', fontSize: 14 },\n  infoPanelText: { fontSize: 12, color: theme.muted, lineHeight: 1.6 },\n  insightBox: { background: `linear-gradient(135deg, ${theme.hidden}15, ${theme.gradient}15)`, borderRadius: 12, padding: 14 },\n  insightTitle: { fontSize: 13, fontWeight: 700, marginBottom: 8 },\n  insightText: { fontSize: 11, color: theme.muted, lineHeight: 1.6, marginBottom: 8 },\n  insightHighlight: { fontSize: 11, color: theme.weight, fontWeight: 600 },\n};\n",
  "settings": {
    "editorHeight": 600,
    "showPreview": true,
    "theme": "auto",
    "showConsole": false,
    "editorWidthPercentage": 35,
    "showEditor": false
  },
  "dependencies": {}
}