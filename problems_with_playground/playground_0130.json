{
  "problem_id": 130,
  "title": "Implement a Simple CNN Training Function with Backpropagation",
  "category": "Deep Learning",
  "enabled": true,
  "type": "react",
  "code": "import React, { useState, useEffect } from 'react';\n\nconst theme = {\n  colors: {\n    primary: '#8b5cf6',\n    background: '#0a0a0a',\n    surface: '#111111',\n    surfaceAlt: '#1a1a1a',\n    border: '#2a2a2a',\n    text: '#fafafa',\n    textSecondary: '#a1a1aa',\n    textMuted: '#52525b',\n    blue: '#38bdf8',\n    yellow: '#fbbf24',\n    pink: '#f472b6',\n    green: '#a3e635',\n    orange: '#fb923c',\n    red: '#f87171',\n  },\n  font: \"'JetBrains Mono', monospace\",\n};\n\n// Preset kernels\nconst KERNEL_PRESETS = {\n  'diagonal': { name: 'Diagonal \\\\', kernel: [[2, 0, -1], [0, 2, 0], [-1, 0, 2]], desc: 'Detects \\\\ diagonals' },\n  'diagonal2': { name: 'Diagonal /', kernel: [[-1, 0, 2], [0, 2, 0], [2, 0, -1]], desc: 'Detects / diagonals' },\n  'edge_h': { name: 'Horizontal Edge', kernel: [[-1, -1, -1], [0, 0, 0], [1, 1, 1]], desc: 'Detects ‚Äî edges' },\n  'edge_v': { name: 'Vertical Edge', kernel: [[-1, 0, 1], [-1, 0, 1], [-1, 0, 1]], desc: 'Detects | edges' },\n  'sharpen': { name: 'Sharpen', kernel: [[0, -1, 0], [-1, 5, -1], [0, -1, 0]], desc: 'Sharpens center' },\n  'blur': { name: 'Blur', kernel: [[1, 1, 1], [1, 1, 1], [1, 1, 1]], desc: 'Averages neighbors' },\n};\n\nexport default function App() {\n  const [step, setStep] = useState(0);\n  const [playing, setPlaying] = useState(false);\n  const [selectedImage, setSelectedImage] = useState(0);\n  const [convPos, setConvPos] = useState({ r: 0, c: 0 });\n  const [animating, setAnimating] = useState(false);\n  const [showBackpropDetails, setShowBackpropDetails] = useState(false);\n  const [kernel, setKernel] = useState([[2, 0, -1], [0, 2, 0], [-1, 0, 2]]);\n  const [selectedPreset, setSelectedPreset] = useState('diagonal');\n\n  const numSteps = 6;\n\n  // 7x7 images\n  const images = [\n    { \n      name: 'X', \n      emoji: '‚úï',\n      data: [\n        [1,0,0,0,0,0,1],\n        [0,1,0,0,0,1,0],\n        [0,0,1,0,1,0,0],\n        [0,0,0,1,0,0,0],\n        [0,0,1,0,1,0,0],\n        [0,1,0,0,0,1,0],\n        [1,0,0,0,0,0,1],\n      ], \n      label: [1, 0] \n    },\n    { \n      name: 'O', \n      emoji: '‚óã',\n      data: [\n        [0,0,1,1,1,0,0],\n        [0,1,0,0,0,1,0],\n        [1,0,0,0,0,0,1],\n        [1,0,0,0,0,0,1],\n        [1,0,0,0,0,0,1],\n        [0,1,0,0,0,1,0],\n        [0,0,1,1,1,0,0],\n      ], \n      label: [0, 1] \n    },\n  ];\n\n  const img = images[selectedImage];\n\n  // Update kernel value\n  const updateKernel = (r, c, delta) => {\n    const newKernel = kernel.map((row, ri) => \n      row.map((val, ci) => ri === r && ci === c ? Math.max(-5, Math.min(5, val + delta)) : val)\n    );\n    setKernel(newKernel);\n    setSelectedPreset('custom');\n  };\n\n  const selectPreset = (presetKey) => {\n    setKernel(KERNEL_PRESETS[presetKey].kernel.map(row => [...row]));\n    setSelectedPreset(presetKey);\n  };\n\n  // Compute single convolution at position\n  const computeConv = (r, c) => {\n    let sum = 0;\n    for (let ki = 0; ki < 3; ki++) {\n      for (let kj = 0; kj < 3; kj++) {\n        sum += img.data[r + ki][c + kj] * kernel[ki][kj];\n      }\n    }\n    return sum;\n  };\n\n  // Full convolution output (5x5)\n  const Z_conv = [];\n  for (let r = 0; r < 5; r++) {\n    const row = [];\n    for (let c = 0; c < 5; c++) {\n      row.push(computeConv(r, c));\n    }\n    Z_conv.push(row);\n  }\n  \n  const A_conv = Z_conv.map(row => row.map(v => Math.max(0, v)));\n  const maxActivation = Math.max(...A_conv.flat(), 1);\n  \n  const A_flat = A_conv.flat();\n  \n  // Dense layer\n  const W_dense = [\n    A_flat.map((_, i) => (i % 6 === 0 || i === 12) ? 0.3 : 0.05),\n    A_flat.map((_, i) => (i % 6 === 0 || i === 12) ? -0.1 : 0.15),\n  ];\n  \n  const score_X = A_flat.reduce((s, v, i) => s + v * W_dense[0][i], 0);\n  const score_O = A_flat.reduce((s, v, i) => s + v * W_dense[1][i], 0);\n  \n  const expSum = Math.exp(score_X) + Math.exp(score_O);\n  const softmax = [Math.exp(score_X) / expSum, Math.exp(score_O) / expSum];\n  const prediction = softmax[0] > softmax[1] ? 0 : 1;\n  const isCorrect = prediction === img.label.indexOf(1);\n  \n  // Backprop\n  const dL_dZ_dense = [softmax[0] - img.label[0], softmax[1] - img.label[1]];\n  const dL_dW_dense = [\n    A_flat.map(a => a * dL_dZ_dense[0]),\n    A_flat.map(a => a * dL_dZ_dense[1]),\n  ];\n  const dL_dA_flat = A_flat.map((_, i) => \n    W_dense[0][i] * dL_dZ_dense[0] + W_dense[1][i] * dL_dZ_dense[1]\n  );\n  const dL_dA_conv = [];\n  for (let r = 0; r < 5; r++) {\n    dL_dA_conv.push(dL_dA_flat.slice(r * 5, r * 5 + 5));\n  }\n  const dL_dZ_conv = Z_conv.map((row, r) => \n    row.map((z, c) => z > 0 ? dL_dA_conv[r][c] : 0)\n  );\n  const dL_dKernel = kernel.map((row, ki) => \n    row.map((_, kj) => {\n      let grad = 0;\n      for (let r = 0; r < 5; r++) {\n        for (let c = 0; c < 5; c++) {\n          grad += dL_dZ_conv[r][c] * img.data[r + ki][c + kj];\n        }\n      }\n      return grad;\n    })\n  );\n\n  // Animate convolution\n  useEffect(() => {\n    if (step === 1 && animating) {\n      const positions = [];\n      for (let r = 0; r < 5; r++) {\n        for (let c = 0; c < 5; c++) {\n          positions.push({ r, c });\n        }\n      }\n      let i = 0;\n      const interval = setInterval(() => {\n        if (i < positions.length) {\n          setConvPos(positions[i]);\n          i++;\n        } else {\n          clearInterval(interval);\n          setAnimating(false);\n        }\n      }, 150);\n      return () => clearInterval(interval);\n    }\n  }, [step, animating]);\n\n  useEffect(() => {\n    if (step === 1) {\n      setAnimating(true);\n      setConvPos({ r: 0, c: 0 });\n    }\n  }, [step]);\n\n  const stepInfo = [\n    { title: 'The Challenge', desc: `Can the network tell this is \"${img.name}\"?`, color: theme.colors.primary },\n    { title: 'Feature Detection', desc: 'Slide kernel across image, looking for patterns', color: theme.colors.blue },\n    { title: 'Activation Map', desc: 'Where did we find the pattern? Bright = strong match', color: theme.colors.yellow },\n    { title: 'Make a Decision', desc: 'Combine evidence to predict X or O', color: theme.colors.pink },\n    { title: 'Check the Answer', desc: `${isCorrect ? 'Correct!' : 'Wrong!'} Now learn from ${isCorrect ? 'success' : 'mistake'}`, color: isCorrect ? theme.colors.green : theme.colors.red },\n    { title: 'Learn & Improve', desc: 'Adjust weights based on the error signal', color: theme.colors.orange },\n  ];\n\n  const play = async () => {\n    setPlaying(true);\n    for (let s = 0; s < numSteps; s++) {\n      setStep(s);\n      await new Promise(r => setTimeout(r, s === 1 ? 4000 : 2500));\n    }\n    setPlaying(false);\n  };\n\n  const reset = () => { setStep(0); setPlaying(false); setConvPos({ r: 0, c: 0 }); setShowBackpropDetails(false); };\n\n  const cellSize = 28;\n  \n  const MiniGrid = ({ data, title, color, size = 24 }) => (\n    <div style={{ textAlign: 'center' }}>\n      <div style={{ fontSize: '10px', color: color || theme.colors.textMuted, marginBottom: '4px' }}>{title}</div>\n      <div style={{ display: 'inline-grid', gridTemplateColumns: `repeat(${data[0].length}, ${size}px)`, gap: '2px' }}>\n        {data.flat().map((v, i) => (\n          <div key={i} style={{\n            width: size, height: size, borderRadius: '3px',\n            background: v > 0.01 ? theme.colors.green + '40' : v < -0.01 ? theme.colors.red + '40' : theme.colors.surfaceAlt,\n            border: `1px solid ${Math.abs(v) > 0.01 ? (v > 0 ? theme.colors.green : theme.colors.red) : theme.colors.border}`,\n            display: 'flex', alignItems: 'center', justifyContent: 'center',\n            fontSize: '8px', color: v > 0 ? theme.colors.green : v < 0 ? theme.colors.red : theme.colors.textMuted,\n          }}>\n            {Math.abs(v) > 0.001 ? v.toFixed(1) : ''}\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n\n  return (\n    <div style={{ background: theme.colors.background, minHeight: '100vh', padding: '12px', fontFamily: theme.font, color: theme.colors.text }}>\n      \n      {/* Header */}\n      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>\n        <div>\n          <div style={{ fontSize: '18px', fontWeight: '700' }}>How CNNs Learn to See</div>\n          <div style={{ fontSize: '12px', color: theme.colors.textSecondary }}>Watch a neural network learn to recognize X vs O</div>\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\n          <button onClick={() => setStep(Math.max(0, step - 1))} disabled={step === 0}\n            style={{ padding: '6px 12px', background: theme.colors.surface, border: 'none', borderRadius: '6px',\n              color: step === 0 ? theme.colors.textMuted : theme.colors.text, fontSize: '14px', cursor: 'pointer' }}>{'<'}</button>\n          <div style={{ display: 'flex', gap: '4px' }}>\n            {Array.from({ length: numSteps }, (_, i) => (\n              <div key={i} onClick={() => setStep(i)} style={{\n                width: i === step ? '16px' : '8px', height: '8px', borderRadius: '4px',\n                background: i <= step ? stepInfo[i].color : theme.colors.border, cursor: 'pointer'\n              }} />\n            ))}\n          </div>\n          <button onClick={() => setStep(Math.min(numSteps - 1, step + 1))} disabled={step === numSteps - 1}\n            style={{ padding: '6px 12px', background: step === numSteps - 1 ? theme.colors.surface : theme.colors.primary,\n              border: 'none', borderRadius: '6px', color: theme.colors.text, fontSize: '14px', cursor: 'pointer' }}>{'>'}</button>\n          <button onClick={play} disabled={playing}\n            style={{ padding: '6px 12px', background: playing ? theme.colors.green : theme.colors.surface,\n              border: 'none', borderRadius: '6px', color: playing ? theme.colors.background : theme.colors.text,\n              fontSize: '12px', cursor: 'pointer' }}>{playing ? '...' : 'Play'}</button>\n          <button onClick={reset}\n            style={{ padding: '6px 10px', background: theme.colors.surface, border: 'none', borderRadius: '6px',\n              color: theme.colors.textSecondary, fontSize: '14px', cursor: 'pointer' }}>~</button>\n        </div>\n      </div>\n\n      {/* Step info */}\n      <div style={{ padding: '10px 14px', background: theme.colors.surface, borderLeft: `4px solid ${stepInfo[step].color}`,\n        borderRadius: '0 8px 8px 0', marginBottom: '12px' }}>\n        <span style={{ fontWeight: '700', color: stepInfo[step].color, fontSize: '15px' }}>{stepInfo[step].title} </span>\n        <span style={{ color: theme.colors.textSecondary, fontSize: '13px' }}>‚Äî {stepInfo[step].desc}</span>\n      </div>\n\n      {/* Image selector */}\n      <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>\n        {images.map((im, i) => (\n          <button key={i} onClick={() => { setSelectedImage(i); setStep(0); setShowBackpropDetails(false); }}\n            style={{\n              padding: '8px 20px', borderRadius: '8px', border: 'none', cursor: 'pointer',\n              background: selectedImage === i ? theme.colors.primary : theme.colors.surface,\n              color: selectedImage === i ? theme.colors.background : theme.colors.text,\n              fontSize: '14px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px',\n            }}>\n            <span style={{ fontSize: '18px' }}>{im.emoji}</span> Show me {im.name}\n          </button>\n        ))}\n      </div>\n\n      <div style={{ display: 'flex', gap: '16px' }}>\n        \n        {/* Left: Input image + Kernel editor */}\n        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>\n          \n          {/* Input image */}\n          <div style={{ background: theme.colors.surface, borderRadius: '12px', padding: '16px' }}>\n            <div style={{ fontSize: '12px', color: theme.colors.textMuted, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}>\n              <span style={{ fontSize: '20px' }}>{img.emoji}</span> Input Image (7√ó7)\n            </div>\n            \n            <div style={{ position: 'relative', display: 'inline-block' }}>\n              <div style={{ display: 'grid', gridTemplateColumns: `repeat(7, ${cellSize}px)`, gap: '2px' }}>\n                {img.data.flat().map((val, i) => {\n                  const r = Math.floor(i / 7);\n                  const c = i % 7;\n                  const inKernel = step >= 1 && r >= convPos.r && r < convPos.r + 3 && c >= convPos.c && c < convPos.c + 3;\n                  const kernelR = r - convPos.r;\n                  const kernelC = c - convPos.c;\n                  const kernelVal = inKernel ? kernel[kernelR][kernelC] : 0;\n                  \n                  return (\n                    <div key={i} style={{\n                      width: cellSize, height: cellSize, borderRadius: '4px',\n                      background: val > 0 \n                        ? (inKernel ? (kernelVal > 0 ? theme.colors.green : kernelVal < 0 ? theme.colors.red : theme.colors.text) : theme.colors.text)\n                        : theme.colors.surfaceAlt,\n                      border: inKernel ? `2px solid ${theme.colors.blue}` : `1px solid ${theme.colors.border}`,\n                      display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      fontSize: '10px', fontWeight: '700',\n                      color: val > 0 ? theme.colors.background : theme.colors.textMuted,\n                      transition: 'all 0.1s ease',\n                    }}>\n                      {inKernel && step === 1 && (\n                        <span style={{ color: theme.colors.background }}>{val > 0 ? (kernelVal > 0 ? '+' : kernelVal < 0 ? '‚àí' : '') : ''}</span>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n            \n            {step === 1 && (\n              <div style={{ marginTop: '8px', fontSize: '12px', color: theme.colors.yellow }}>\n                Position ({convPos.r}, {convPos.c}): sum = {computeConv(convPos.r, convPos.c)}\n              </div>\n            )}\n          </div>\n\n          {/* Kernel editor */}\n          <div style={{ background: theme.colors.surface, borderRadius: '12px', padding: '16px' }}>\n            <div style={{ fontSize: '12px', color: theme.colors.blue, fontWeight: '600', marginBottom: '10px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\n              <span>üîß Kernel (3√ó3)</span>\n              <span style={{ fontSize: '10px', color: theme.colors.textMuted, fontWeight: '400' }}>click ¬± to edit</span>\n            </div>\n            \n            {/* Kernel presets */}\n            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '12px' }}>\n              {Object.entries(KERNEL_PRESETS).map(([key, { name }]) => (\n                <button key={key} onClick={() => selectPreset(key)}\n                  style={{\n                    padding: '4px 8px', borderRadius: '4px', border: 'none', cursor: 'pointer',\n                    background: selectedPreset === key ? theme.colors.blue : theme.colors.surfaceAlt,\n                    color: selectedPreset === key ? theme.colors.background : theme.colors.textSecondary,\n                    fontSize: '10px', fontWeight: '500',\n                  }}>\n                  {name}\n                </button>\n              ))}\n              {selectedPreset === 'custom' && (\n                <span style={{ padding: '4px 8px', fontSize: '10px', color: theme.colors.orange }}>Custom</span>\n              )}\n            </div>\n            \n            {/* Editable kernel grid - click to increase, shift+click to decrease */}\n            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '3px' }}>\n                {kernel.map((row, ri) => \n                  row.map((val, ci) => (\n                    <div key={`${ri}-${ci}`} \n                      onClick={(e) => updateKernel(ri, ci, e.shiftKey ? -1 : 1)}\n                      style={{\n                        width: '36px', height: '36px', borderRadius: '6px',\n                        background: val > 0 ? theme.colors.green + '40' : val < 0 ? theme.colors.red + '40' : theme.colors.surfaceAlt,\n                        border: `2px solid ${val > 0 ? theme.colors.green : val < 0 ? theme.colors.red : theme.colors.border}`,\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        fontSize: '14px', fontWeight: '700',\n                        color: val > 0 ? theme.colors.green : val < 0 ? theme.colors.red : theme.colors.textMuted,\n                        cursor: 'pointer', userSelect: 'none',\n                        transition: 'transform 0.1s',\n                      }}\n                      onMouseDown={(e) => e.currentTarget.style.transform = 'scale(0.95)'}\n                      onMouseUp={(e) => e.currentTarget.style.transform = 'scale(1)'}\n                      onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>\n                      {val > 0 ? `+${val}` : val}\n                    </div>\n                  ))\n                )}\n              </div>\n              \n              <div style={{ fontSize: '11px', color: theme.colors.textSecondary, lineHeight: 1.6 }}>\n                <div style={{ color: theme.colors.textMuted, marginBottom: '6px' }}>\n                  Click +1 ¬∑ Shift+click ‚àí1\n                </div>\n                <div><span style={{ color: theme.colors.green }}>+</span> rewards match</div>\n                <div><span style={{ color: theme.colors.red }}>‚àí</span> penalizes</div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Middle: Feature map / Activation / Backprop */}\n        <div style={{ background: theme.colors.surface, borderRadius: '12px', padding: '16px', flex: 1 }}>\n          \n          {step < 2 ? (\n            <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', color: theme.colors.textMuted }}>\n              <div style={{ fontSize: '48px', marginBottom: '8px' }}>üîç</div>\n              <div style={{ fontSize: '13px' }}>Scanning for patterns...</div>\n            </div>\n          ) : step < 4 ? (\n            <>\n              <div style={{ fontSize: '12px', color: theme.colors.yellow, marginBottom: '8px', fontWeight: '600' }}>\n                Feature Map: \"Where did I find the pattern?\"\n              </div>\n              \n              <div style={{ display: 'flex', gap: '20px', alignItems: 'flex-start' }}>\n                <div>\n                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 40px)', gap: '3px' }}>\n                    {A_conv.flat().map((val, i) => {\n                      const intensity = maxActivation > 0 ? val / maxActivation : 0;\n                      return (\n                        <div key={i} style={{\n                          width: '40px', height: '40px', borderRadius: '6px',\n                          background: val > 0 \n                            ? `rgba(251, 191, 36, ${0.2 + intensity * 0.8})`\n                            : theme.colors.surfaceAlt,\n                          border: `2px solid ${val > 0 ? theme.colors.yellow : theme.colors.border}`,\n                          display: 'flex', alignItems: 'center', justifyContent: 'center',\n                          fontSize: '11px', fontWeight: '700',\n                          color: val > 0 ? theme.colors.background : theme.colors.textMuted,\n                        }}>\n                          {val > 0 ? val : '0'}\n                        </div>\n                      );\n                    })}\n                  </div>\n                  <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginTop: '6px', textAlign: 'center' }}>\n                    Brighter = stronger match\n                  </div>\n                </div>\n                \n                <div style={{ fontSize: '12px', color: theme.colors.textSecondary, lineHeight: 1.8 }}>\n                  <div style={{ fontWeight: '600', color: theme.colors.yellow, marginBottom: '8px' }}>Analysis:</div>\n                  <div>Total activation: <span style={{ color: theme.colors.yellow }}>{A_conv.flat().reduce((a,b) => a+b, 0)}</span></div>\n                  <div>Max value: <span style={{ color: theme.colors.yellow }}>{maxActivation}</span></div>\n                  <div style={{ marginTop: '8px', color: theme.colors.textMuted }}>\n                    Try different kernels to see what patterns they detect!\n                  </div>\n                </div>\n              </div>\n            </>\n          ) : step === 4 ? (\n            <>\n              <div style={{ fontSize: '12px', color: isCorrect ? theme.colors.green : theme.colors.red, marginBottom: '12px', fontWeight: '600' }}>\n                {isCorrect ? '‚úì Correct!' : '‚úó Wrong!'} The network predicted:\n              </div>\n              \n              <div style={{ display: 'flex', gap: '20px', alignItems: 'center', justifyContent: 'center', marginBottom: '16px' }}>\n                {[{ sym: '‚úï', prob: softmax[0], target: img.label[0] }, { sym: '‚óã', prob: softmax[1], target: img.label[1] }].map((item, i) => (\n                  <div key={i} style={{\n                    padding: '16px 24px', borderRadius: '12px', textAlign: 'center',\n                    background: item.target === 1 ? theme.colors.green + '20' : item.prob > 0.5 ? theme.colors.red + '20' : theme.colors.surface,\n                    border: `3px solid ${item.target === 1 ? theme.colors.green : item.prob > 0.5 ? theme.colors.red : theme.colors.border}`,\n                  }}>\n                    <div style={{ fontSize: '36px', marginBottom: '8px' }}>{item.sym}</div>\n                    <div style={{ fontSize: '24px', fontWeight: '700', color: item.prob > 0.5 ? (item.target === 1 ? theme.colors.green : theme.colors.red) : theme.colors.textMuted }}>\n                      {(item.prob * 100).toFixed(0)}%\n                    </div>\n                    {item.target === 1 && <div style={{ fontSize: '11px', color: theme.colors.green, marginTop: '4px' }}>‚Üê correct</div>}\n                  </div>\n                ))}\n              </div>\n              \n              <div style={{ padding: '12px', background: theme.colors.surfaceAlt, borderRadius: '8px', fontSize: '13px', color: theme.colors.textSecondary }}>\n                {isCorrect ? (\n                  <span><span style={{ color: theme.colors.green }}>Great!</span> The kernel helps distinguish {img.name}.</span>\n                ) : (\n                  <span><span style={{ color: theme.colors.red }}>Wrong!</span> Try a different kernel that better captures {img.name}'s features.</span>\n                )}\n              </div>\n            </>\n          ) : (\n            <>\n              <div style={{ fontSize: '12px', color: theme.colors.orange, marginBottom: '12px', fontWeight: '600' }}>\n                Learning: Adjust weights based on feedback\n              </div>\n              \n              {/* Error signal */}\n              <div style={{ display: 'flex', gap: '16px', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap' }}>\n                <div style={{ textAlign: 'center' }}>\n                  <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginBottom: '4px' }}>Predicted</div>\n                  <div style={{ fontSize: '16px' }}>{softmax[0] > softmax[1] ? '‚úï' : '‚óã'} {(Math.max(...softmax) * 100).toFixed(0)}%</div>\n                </div>\n                <div style={{ fontSize: '20px', color: theme.colors.textMuted }}>‚àí</div>\n                <div style={{ textAlign: 'center' }}>\n                  <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginBottom: '4px' }}>Target</div>\n                  <div style={{ fontSize: '16px' }}>{img.emoji} 100%</div>\n                </div>\n                <div style={{ fontSize: '20px', color: theme.colors.textMuted }}>=</div>\n                <div style={{ textAlign: 'center' }}>\n                  <div style={{ fontSize: '10px', color: theme.colors.red, marginBottom: '4px' }}>Error</div>\n                  <div style={{ display: 'flex', gap: '6px' }}>\n                    {['‚úï', '‚óã'].map((sym, i) => (\n                      <div key={i} style={{ padding: '4px 8px', borderRadius: '4px', background: theme.colors.red + '20', border: `1px solid ${theme.colors.red}` }}>\n                        <span style={{ fontSize: '12px' }}>{sym}</span>\n                        <span style={{ fontSize: '12px', fontWeight: '700', color: dL_dZ_dense[i] < 0 ? theme.colors.green : theme.colors.red, marginLeft: '4px' }}>\n                          {dL_dZ_dense[i] > 0 ? '+' : ''}{dL_dZ_dense[i].toFixed(2)}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              {/* Explanation */}\n              <div style={{ padding: '12px', background: theme.colors.surfaceAlt, borderRadius: '8px', marginBottom: '12px' }}>\n                <div style={{ fontSize: '13px', color: theme.colors.text, marginBottom: '6px', fontWeight: '600' }}>\n                  What the error means:\n                </div>\n                <div style={{ fontSize: '12px', color: theme.colors.textSecondary, lineHeight: 1.7 }}>\n                  {img.name === 'X' ? (\n                    <><span style={{ color: theme.colors.green }}>Negative error for X</span> ‚Üí Need to <strong>increase</strong> X output<br/>\n                    <span style={{ color: theme.colors.red }}>Positive error for O</span> ‚Üí Need to <strong>decrease</strong> O output</>\n                  ) : (\n                    <><span style={{ color: theme.colors.red }}>Positive error for X</span> ‚Üí Need to <strong>decrease</strong> X output<br/>\n                    <span style={{ color: theme.colors.green }}>Negative error for O</span> ‚Üí Need to <strong>increase</strong> O output</>\n                  )}\n                </div>\n              </div>\n\n              {/* Update formula */}\n              <div style={{ padding: '12px', background: theme.colors.green + '15', borderRadius: '8px', border: `1px solid ${theme.colors.green}` }}>\n                <div style={{ fontSize: '12px', color: theme.colors.green, fontWeight: '600' }}>\n                  Update Rule: W ‚Üê W ‚àí Œ∑ √ó gradient\n                </div>\n                <div style={{ fontSize: '11px', color: theme.colors.textSecondary, marginTop: '4px' }}>\n                  Weights that contributed to error get adjusted proportionally.\n                </div>\n              </div>\n              \n              {/* Collapsible backprop details */}\n              <div style={{ marginTop: '12px' }}>\n                <button \n                  onClick={() => setShowBackpropDetails(!showBackpropDetails)}\n                  style={{\n                    width: '100%', padding: '10px 14px', borderRadius: '8px',\n                    background: theme.colors.surface, border: `1px solid ${theme.colors.orange}`,\n                    color: theme.colors.orange, fontSize: '13px', fontWeight: '600',\n                    cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'space-between',\n                  }}>\n                  <span>üìö Show Full Backprop Walkthrough</span>\n                  <span style={{ transform: showBackpropDetails ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}>‚ñº</span>\n                </button>\n                \n                {showBackpropDetails && (\n                  <div style={{ marginTop: '12px', padding: '16px', background: theme.colors.surfaceAlt, borderRadius: '8px', border: `1px solid ${theme.colors.border}` }}>\n                    \n                    {/* Layer 1: Output */}\n                    <div style={{ marginBottom: '20px' }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>\n                        <div style={{ width: '24px', height: '24px', borderRadius: '50%', background: theme.colors.red, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', color: theme.colors.background }}>1</div>\n                        <div style={{ fontSize: '13px', fontWeight: '600', color: theme.colors.red }}>Output: ‚àÇLoss/‚àÇScores</div>\n                      </div>\n                      <div style={{ marginLeft: '32px', padding: '12px', background: theme.colors.surface, borderRadius: '8px' }}>\n                        <div style={{ fontSize: '12px', color: theme.colors.textSecondary, marginBottom: '8px' }}>\n                          Softmax + cross-entropy gradient:\n                        </div>\n                        <div style={{ fontFamily: 'monospace', fontSize: '12px', color: theme.colors.text, marginBottom: '8px' }}>\n                          ‚àÇL/‚àÇz = softmax ‚àí target = [{dL_dZ_dense[0].toFixed(3)}, {dL_dZ_dense[1].toFixed(3)}]\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Layer 2: Dense */}\n                    <div style={{ marginBottom: '20px' }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>\n                        <div style={{ width: '24px', height: '24px', borderRadius: '50%', background: theme.colors.orange, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', color: theme.colors.background }}>2</div>\n                        <div style={{ fontSize: '13px', fontWeight: '600', color: theme.colors.orange }}>Dense: ‚àÇLoss/‚àÇWeights</div>\n                      </div>\n                      <div style={{ marginLeft: '32px', padding: '12px', background: theme.colors.surface, borderRadius: '8px' }}>\n                        <div style={{ fontSize: '12px', color: theme.colors.textSecondary, marginBottom: '8px' }}>\n                          ‚àÇL/‚àÇW = input √ó error\n                        </div>\n                        <div style={{ display: 'flex', gap: '16px', alignItems: 'flex-start' }}>\n                          <MiniGrid data={dL_dA_conv} title=\"‚àÇL/‚àÇA_conv (5√ó5)\" color={theme.colors.orange} size={24} />\n                          <div style={{ fontSize: '11px', color: theme.colors.textSecondary, lineHeight: 1.6, paddingTop: '20px' }}>\n                            <span style={{ color: theme.colors.green }}>Green</span> = increase<br/>\n                            <span style={{ color: theme.colors.red }}>Red</span> = decrease\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Layer 3: ReLU */}\n                    <div style={{ marginBottom: '20px' }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>\n                        <div style={{ width: '24px', height: '24px', borderRadius: '50%', background: theme.colors.yellow, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', color: theme.colors.background }}>3</div>\n                        <div style={{ fontSize: '13px', fontWeight: '600', color: theme.colors.yellow }}>ReLU: Gate Gradients</div>\n                      </div>\n                      <div style={{ marginLeft: '32px', padding: '12px', background: theme.colors.surface, borderRadius: '8px' }}>\n                        <div style={{ fontSize: '12px', color: theme.colors.textSecondary, marginBottom: '8px' }}>\n                          Gradient = 1 if input &gt; 0, else 0\n                        </div>\n                        <MiniGrid data={dL_dZ_conv} title=\"‚àÇL/‚àÇZ_conv (gated)\" color={theme.colors.yellow} size={24} />\n                      </div>\n                    </div>\n\n                    {/* Layer 4: Conv */}\n                    <div>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>\n                        <div style={{ width: '24px', height: '24px', borderRadius: '50%', background: theme.colors.blue, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', color: theme.colors.background }}>4</div>\n                        <div style={{ fontSize: '13px', fontWeight: '600', color: theme.colors.blue }}>Conv Kernel: ‚àÇLoss/‚àÇKernel</div>\n                      </div>\n                      <div style={{ marginLeft: '32px', padding: '12px', background: theme.colors.surface, borderRadius: '8px' }}>\n                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>\n                          <div style={{ textAlign: 'center' }}>\n                            <div style={{ fontSize: '10px', color: theme.colors.textMuted, marginBottom: '4px' }}>Current</div>\n                            <div style={{ display: 'inline-grid', gridTemplateColumns: 'repeat(3, 28px)', gap: '2px' }}>\n                              {kernel.flat().map((v, i) => (\n                                <div key={i} style={{\n                                  width: 28, height: 28, borderRadius: '4px',\n                                  background: theme.colors.blue + '30', border: `2px solid ${theme.colors.blue}`,\n                                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                                  fontSize: '10px', fontWeight: '700', color: theme.colors.blue,\n                                }}>{v > 0 ? '+' : ''}{v}</div>\n                              ))}\n                            </div>\n                          </div>\n                          <div style={{ fontSize: '16px', color: theme.colors.textMuted }}>‚àíŒ∑√ó</div>\n                          <MiniGrid data={dL_dKernel} title=\"Gradient\" color={theme.colors.red} size={28} />\n                          <div style={{ fontSize: '16px', color: theme.colors.textMuted }}>=</div>\n                          <div style={{ textAlign: 'center' }}>\n                            <div style={{ fontSize: '10px', color: theme.colors.green, marginBottom: '4px' }}>Updated</div>\n                            <div style={{ display: 'inline-grid', gridTemplateColumns: 'repeat(3, 28px)', gap: '2px' }}>\n                              {kernel.flat().map((v, i) => {\n                                const newVal = v - 0.1 * dL_dKernel.flat()[i];\n                                return (\n                                  <div key={i} style={{\n                                    width: 28, height: 28, borderRadius: '4px',\n                                    background: theme.colors.green + '30', border: `2px solid ${theme.colors.green}`,\n                                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                                    fontSize: '9px', fontWeight: '700', color: theme.colors.green,\n                                  }}>{newVal.toFixed(1)}</div>\n                                );\n                              })}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Summary */}\n                    <div style={{ marginTop: '16px', padding: '12px', background: theme.colors.primary + '15', borderRadius: '8px', border: `1px solid ${theme.colors.primary}` }}>\n                      <div style={{ fontSize: '12px', color: theme.colors.primary, fontWeight: '600', marginBottom: '6px' }}>\n                        üéØ Chain Rule in Action\n                      </div>\n                      <div style={{ fontSize: '11px', color: theme.colors.textSecondary }}>\n                        Error flows: Output ‚Üí Dense ‚Üí ReLU ‚Üí Conv kernel. Each layer adjusts based on its contribution.\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </>\n          )}\n        </div>\n\n        {/* Right: Prediction panel */}\n        {step >= 3 && (\n          <div style={{ background: theme.colors.surface, borderRadius: '12px', padding: '16px', width: '140px' }}>\n            <div style={{ fontSize: '12px', color: theme.colors.pink, marginBottom: '12px', fontWeight: '600' }}>\n              Prediction\n            </div>\n            \n            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>\n              {['‚úï', '‚óã'].map((sym, i) => (\n                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                  <span>{sym}</span>\n                  <div style={{ flex: 1, height: '8px', background: theme.colors.surfaceAlt, borderRadius: '4px', margin: '0 8px', overflow: 'hidden' }}>\n                    <div style={{ width: `${softmax[i] * 100}%`, height: '100%', background: theme.colors.pink, borderRadius: '4px' }} />\n                  </div>\n                  <span style={{ fontSize: '11px', fontWeight: '600', width: '32px' }}>{(softmax[i] * 100).toFixed(0)}%</span>\n                </div>\n              ))}\n              \n              <div style={{ \n                padding: '12px', borderRadius: '8px', textAlign: 'center', marginTop: '8px',\n                background: step >= 4 ? (isCorrect ? theme.colors.green + '20' : theme.colors.red + '20') : theme.colors.pink + '20',\n                border: `2px solid ${step >= 4 ? (isCorrect ? theme.colors.green : theme.colors.red) : theme.colors.pink}`,\n              }}>\n                <div style={{ fontSize: '10px', color: theme.colors.textMuted }}>Answer:</div>\n                <div style={{ fontSize: '28px' }}>{softmax[0] > softmax[1] ? '‚úï' : '‚óã'}</div>\n                {step >= 4 && (\n                  <div style={{ fontSize: '10px', color: isCorrect ? theme.colors.green : theme.colors.red }}>\n                    {isCorrect ? '‚úì Correct!' : '‚úó Wrong'}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Key Insight */}\n      <div style={{ background: theme.colors.surfaceAlt, borderRadius: '8px', padding: '12px 16px', marginTop: '12px',\n        fontSize: '12px', color: theme.colors.textSecondary, borderLeft: `4px solid ${theme.colors.primary}` }}>\n        <span style={{ color: theme.colors.primary, fontWeight: '600' }}>üí° Insight: </span>\n        {step === 0 && 'A CNN learns to recognize patterns using kernels. Try different kernels to see what patterns they detect!'}\n        {step === 1 && 'The kernel slides across, computing how well each region matches. Watch the sum change at each position.'}\n        {step === 2 && 'The activation map shows where patterns were found. Try the \"/\" kernel on X vs the \"\\\\\" kernel!'}\n        {step === 3 && 'The network combines activations to make a prediction. Different kernels give different results.'}\n        {step === 4 && (isCorrect ? 'The kernel helps! Try other kernels to see which works best.' : 'Try a kernel that better captures ' + img.name + \"'s shape.\")}\n        {step === 5 && 'Backprop adjusts the kernel to better detect the right patterns. Click \"Show Full Backprop Walkthrough\" for details!'}\n      </div>\n    </div>\n  );\n}",
  "settings": {
    "editorHeight": 600,
    "showPreview": true,
    "theme": "auto",
    "showEditor": false,
    "editorWidthPercentage": 35,
    "showConsole": false
  },
  "dependencies": {}
}